# Техническая документация: Converter

## 1. Архитектура

Проект находится в процессе перехода от традиционной архитектуры WinForms к современной многоуровневой архитектуре, вдохновленной принципами **Domain-Driven Design (DDD)** и **Model-View-Presenter (MVP)**. Это позволяет разделить бизнес-логику, логику приложения и пользовательский интерфейс, делая систему более гибкой, тестируемой и простой в сопровождении.

### 1.1. Новая архитектура (в директории `src`)

-   **`Converter.Domain`**: Ядро приложения. Содержит основные бизнес-модели и сущности, такие как `ConversionSettings` и `QueueItem`. Этот слой не зависит от других слоев проекта.
-   **`Converter.Application`**: Содержит логику приложения и варианты использования.
    -   **`Abstractions`**: Определяет интерфейсы (`IConversionOrchestrator`, `IFFmpegExecutor`, `IQueueService`), которые являются контрактами для реализации в инфраструктурном слое.
    -   **`Presenters`**: `MainPresenter` выступает в роли посредника между UI (`IMainView`) и бизнес-логикой, обрабатывая действия пользователя и обновляя представление.
-   **`Converter.Infrastructure`**: Реализует интерфейсы, определенные в `Converter.Application`. Отвечает за взаимодействие с внешними системами:
    -   **`Ffmpeg`**: Обертки для работы с FFmpeg (`FFmpegExecutor`).
    -   **`Persistence`**: Механизмы сохранения и загрузки данных (`FileSettingsStore`, `JsonPresetRepository`).

### 1.2. Устаревшая структура

-   **`Form1.cs`, `Form1.UI.cs`**: Основная форма приложения. В новой архитектуре `Form1` реализует интерфейс `IMainView` и делегирует обработку событий `MainPresenter`. Часть логики все еще находится здесь, но постепенно переносится в презентер и сервисы.
-   **`Services/`**: Набор сервисов (`QueueManager`, `PresetService` и др.), реализующих различную функциональность. В новой архитектуре эта логика переезжает в слой `Application` и `Infrastructure`.
-   **`Models/`**: Содержит модели данных, используемые в устаревшей части приложения. Постепенно заменяются моделями из `Converter.Domain`.

### 1.3. Паттерн Model-View-Presenter (MVP)

1.  **View (`Form1`)**: Отвечает только за отображение данных и перехват действий пользователя. Не содержит бизнес-логики. При возникновении события (например, клик по кнопке) вызывает соответствующий метод презентера.
2.  **Presenter (`MainPresenter`)**: Получает данные от View, обрабатывает их, взаимодействует с сервисами из слоя `Application` и возвращает результат обратно в View для отображения.
3.  **Model (`Converter.Domain`)**: Представляет данные и бизнес-логику приложения.

## 2. Поток выполнения конвертации

1.  **Инициация**: Пользователь добавляет файлы через UI (`DragDropPanel`). `Form1` (View) уведомляет `MainPresenter` об этом.
2.  **Обработка в Application**: `MainPresenter` использует `IQueueService` для добавления файлов в очередь.
3.  **Выполнение**: `IConversionOrchestrator` (оркестратор конвертации) запускает процесс. Он использует `IFFmpegExecutor` для формирования команды и запуска процесса FFmpeg.
4.  **Инфраструктура**: `FFmpegExecutor` в `Converter.Infrastructure` выполняет команду FFmpeg, отслеживает прогресс и перехватывает вывод.
5.  **Обратная связь**: `FFmpegExecutor` через события уведомляет `IConversionOrchestrator` о прогрессе. Оркестратор обновляет `QueueItem` в `IQueueService`.
6.  **Обновление UI**: `MainPresenter`, подписанный на события `IQueueService`, получает обновления и передает их `Form1` (View) для отображения прогресса пользователю.

## 3. Компоненты UI (директория `UI/`)

Директория `UI/` содержит переиспользуемые элементы управления, диалоги и панели, которые инкапсулируют определенную часть функциональности интерфейса. Подробное описание компонентов находится в файле `UI/README.md`.

## 4. Расширение

-   **Добавление пресетов**: Новые пресеты можно добавить в виде XML или JSON файлов. `JsonPresetRepository` и `XmlPresetLoader` отвечают за их загрузку.
-   **Новые опции кодирования**: Для добавления новых опций необходимо расширить модель `ConversionSettings` в `Converter.Domain`, обновить UI для их настройки и учесть их при построении команды FFmpeg в `ConversionCommandBuilder`.
-   **Поддержка других платформ**: Благодаря разделению логики, можно относительно легко создать UI на другой технологии (например, WPF или MAUI), реализовав соответствующие интерфейсы представлений (`IMainView`) и используя существующие слои `Domain`, `Application` и `Infrastructure`.